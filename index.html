<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - MAIL SHOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #111827; color: #d1d5db; }
        .sidebar a { border-left: 3px solid transparent; transition: all 0.2s; }
        .sidebar a:hover { background-color: #374151; }
        .sidebar a.active { background-color: #1d4ed8; color: white; border-left-color: #60a5fa; }
        .stat-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; cursor: pointer; border: none; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; word-break: break-word; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; text-transform: uppercase; font-size: 0.75rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; max-width: 90%; width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="admin-login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h1 class="text-3xl font-bold text-center text-gray-900">MAIL SHOP Admin Login</h1>
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button id="admin-login-btn" class="w-full btn btn-primary">Login</button>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <div class="flex h-screen">
            <aside class="sidebar w-64 flex-shrink-0 overflow-y-auto">
                <div class="p-4 text-2xl font-bold text-white">MAIL SHOP</div>
                <nav class="mt-8">
                    <a href="#" class="nav-link block py-3 px-4" data-page="dashboard-page"><i data-lucide="layout-dashboard" class="inline-block w-5 h-5 mr-2"></i>Dashboard</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="users-page"><i data-lucide="users" class="inline-block w-5 h-5 mr-2"></i>Users</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="notifications-page"><i data-lucide="send" class="inline-block w-5 h-5 mr-2"></i>Notifications</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="deposits-page"><i data-lucide="arrow-down-circle" class="inline-block w-5 h-5 mr-2"></i>Deposits</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="recharge-page"><i data-lucide="smartphone" class="inline-block w-5 h-5 mr-2"></i>Recharge Requests</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="purchases-page"><i data-lucide="shopping-cart" class="inline-block w-5 h-5 mr-2"></i>Mail Purchases</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="stock-page"><i data-lucide="package-plus" class="inline-block w-5 h-5 mr-2"></i>Add Stock</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="manage-mails-page"><i data-lucide="edit" class="inline-block w-5 h-5 mr-2"></i>Manage Mails</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="updates-page"><i data-lucide="megaphone" class="inline-block w-5 h-5 mr-2"></i>Manage Updates</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="tutorials-page"><i data-lucide="video" class="inline-block w-5 h-5 mr-2"></i>Manage Tutorials</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="reviews-page"><i data-lucide="star" class="inline-block w-5 h-5 mr-2"></i>User Reviews</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="support-page"><i data-lucide="life-buoy" class="inline-block w-5 h-5 mr-2"></i>Support Links</a>
                    <a href="#" class="nav-link block py-3 px-4" data-page="settings-page"><i data-lucide="settings" class="inline-block w-5 h-5 mr-2"></i>App Settings</a>
                    <a href="#" id="admin-logout-btn" class="block py-3 px-4 mt-8 text-red-400 hover:bg-red-500 hover:text-white"><i data-lucide="log-out" class="inline-block w-5 h-5 mr-2"></i>Logout</a>
                </nav>
            </aside>

            <main class="flex-1 p-8 overflow-y-auto bg-gray-100">
                <div id="dashboard-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">Total Users</h2><p id="total-users" class="text-4xl font-bold mt-2 text-indigo-600">0</p></div>
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">Total Approved Deposits</h2><p id="total-deposits-amount" class="text-4xl font-bold mt-2 text-green-600">৳0</p></div>
                         <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">Total Mails Sold</h2><p id="total-mails-sold" class="text-4xl font-bold mt-2 text-blue-600">0</p></div>
                        <div class="stat-card p-6"><h2 class="text-gray-500 text-lg">Pending Requests</h2>
                            <div class="mt-2 text-lg space-y-1">
                                <p>Deposits: <span id="pending-deposits" class="font-bold text-yellow-600">0</span></p>
                                <p>Recharges: <span id="pending-recharges" class="font-bold text-orange-600">0</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-700">Available Mail Stock</h2>
                            <div id="stock-overview-container" class="space-y-3">
                                <p>Loading stock data...</p>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-700">New User Registrations (Last 7 Days)</h2>
                            <canvas id="user-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="users-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">User Management</h1>
                    <div class="mb-4"><input type="text" id="user-search" class="w-full max-w-sm px-4 py-2 border rounded-lg" placeholder="Search by name or User ID..."></div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                        <table class="min-w-full">
                            <thead><tr><th>Name</th><th>User ID</th><th>Balance</th><th>PIN Status</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="notifications-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Send Notifications</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Send to All Users (Broadcast)</h2>
                            <div class="space-y-4">
                                <div><label class="block font-semibold">Title</label><input type="text" id="broadcast-title" class="w-full px-3 py-2 border rounded"></div>
                                <div><label class="block font-semibold">Message</label><textarea id="broadcast-message" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                                <button id="send-broadcast-btn" class="w-full btn btn-primary">Send Broadcast</button>
                            </div>
                        </div>
                        <div class="stat-card p-6">
                            <h2 class="text-xl font-bold mb-4">Send to Individual User</h2>
                             <div class="space-y-4">
                                <div><label class="block font-semibold">Recipient User ID</label><input type="text" id="direct-user-id" class="w-full px-3 py-2 border rounded" placeholder="Enter Telegram User ID"></div>
                                <div><label class="block font-semibold">Title</label><input type="text" id="direct-title" class="w-full px-3 py-2 border rounded"></div>
                                <div><label class="block font-semibold">Message</label><textarea id="direct-message" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                                <button id="send-direct-btn" class="w-full btn btn-primary">Send Direct Message</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="deposits-page" class="page">
                     <h1 class="text-3xl font-bold mb-6 text-gray-800">Pending Deposit Requests</h1>
                     <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                        <table>
                            <thead><tr><th>User Name</th><th>Amount (BDT)</th><th>Method</th><th>Sender No.</th><th>TrxID</th><th>Time</th><th>Actions</th></tr></thead>
                            <tbody id="deposits-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="recharge-page" class="page">
                     <h1 class="text-3xl font-bold mb-6 text-gray-800">Pending Recharge Requests</h1>
                     <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                        <table>
                            <thead><tr><th>User Name</th><th>Amount</th><th>Number</th><th>Operator</th><th>Type</th><th>Time</th><th>Actions</th></tr></thead>
                            <tbody id="recharge-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="purchases-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Mail Purchase History</h1>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                       <table>
                           <thead><tr><th>Sale ID</th><th>Date</th><th>User Name</th><th>Mail Type</th><th>Mail Details</th><th>Cost</th></tr></thead>
                           <tbody id="purchases-table-body"></tbody>
                       </table>
                   </div>
                </div>

                <div id="stock-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Add Mail Stock</h1>
                    <div class="stat-card p-6">
                        <h3 class="font-semibold text-xl text-gray-800 mb-4">Add New Mails</h3>
                        <p class="text-sm text-gray-600 mb-4">ফরম্যাট: <code class="bg-gray-200 p-1 rounded text-gray-700">email/password/refresh_token/client_id</code></p>
                        <div class="mb-4">
                            <label for="mail-type-select-add" class="block text-sm font-medium text-gray-700 mb-1">Select Mail Type</label>
                            <select id="mail-type-select-add" class="w-full p-3 rounded-lg border border-gray-300"></select>
                        </div>
                        <div class="mb-4">
                            <label for="mail-data-textarea" class="block text-sm font-medium text-gray-700 mb-1">Mail Data (one per line)</label>
                            <textarea id="mail-data-textarea" rows="12" placeholder="mail@example.com/password/refresh_token/client_id" class="w-full p-3 rounded-lg border border-gray-300 font-mono text-xs"></textarea>
                        </div>
                        <button id="add-mails-btn" class="btn btn-primary w-full">Add Mails to Stock</button>
                    </div>
                </div>
                
                <div id="manage-mails-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Individual Mails</h1>
                    <div class="stat-card p-6">
                        <div class="mb-4">
                             <label for="mail-type-select-manage" class="block text-sm font-medium text-gray-700 mb-1">Select Mail Type to View Stock</label>
                            <select id="mail-type-select-manage" class="w-full p-3 rounded-lg border border-gray-300"></select>
                        </div>
                        <div id="individual-mails-container" class="overflow-x-auto">
                            <p class="text-gray-500">Please select a mail type to see the available stock.</p>
                        </div>
                    </div>
                </div>

                <div id="updates-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Updates</h1>
                     <div class="stat-card p-6">
                        <h2 class="text-xl font-bold mb-4" id="update-form-title">Add New Update</h2>
                        <form id="update-form" class="space-y-4">
                            <input type="hidden" id="update-id">
                            <div><label class="block font-semibold">Title</label><input type="text" id="update-title" class="w-full px-3 py-2 border rounded" required></div>
                            <div><label class="block font-semibold">Content / Message</label><textarea id="update-content" rows="4" class="w-full px-3 py-2 border rounded"></textarea></div>
                            <div><label class="block font-semibold">Image URL</label><input type="text" id="update-imageUrl" class="w-full px-3 py-2 border rounded" required></div>
                            <div><label class="block font-semibold">Link URL (Optional)</label><input type="text" id="update-linkUrl" class="w-full px-3 py-2 border rounded" placeholder="https://example.com/more-info"></div>
                            <div class="flex space-x-2">
                                <button type="submit" id="update-submit-btn" class="w-full btn btn-primary">Post Update</button>
                                <button type="button" id="update-cancel-btn" class="w-full btn bg-gray-300 hidden">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white shadow-md rounded-lg overflow-x-auto mt-8">
                        <h2 class="text-xl font-bold p-4">Current Updates</h2>
                        <table>
                            <thead><tr><th>Title</th><th>Posted On</th><th>Likes/Dislikes</th><th>Actions</th></tr></thead>
                            <tbody id="updates-table-body"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="tutorials-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Tutorials</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4" id="tutorial-form-title">Create New Tutorial</h2>
                                <form id="tutorial-form" class="space-y-4">
                                    <input type="hidden" id="tutorial-id">
                                    <div><label class="block font-semibold">Title</label><input type="text" id="tutorial-title" class="w-full px-3 py-2 border rounded" required></div>
                                    <div><label class="block font-semibold">YouTube Embed URL</label><input type="url" id="tutorial-youtubeEmbedUrl" class="w-full px-3 py-2 border rounded" placeholder="e.g., https://www.youtube.com/embed/VIDEO_ID"></div>
                                    <div><label class="block font-semibold">Order (for display)</label><input type="number" id="tutorial-order" class="w-full px-3 py-2 border rounded" value="0"></div>
                                    <div class="flex space-x-2">
                                        <button type="submit" id="tutorial-submit-btn" class="w-full btn btn-primary">Create Tutorial</button>
                                        <button type="button" id="tutorial-cancel-btn" class="w-full btn bg-gray-300 hidden">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4">Current Tutorials</h2>
                                <div id="tutorials-list" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="reviews-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage User Reviews</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4">Add New Review</h2>
                                <form id="review-form" class="space-y-4">
                                    <div><label class="block font-semibold">User Name</label><input type="text" id="review-name" class="w-full px-3 py-2 border rounded" required></div>
                                    <div><label class="block font-semibold">Rating (1-5)</label><input type="number" id="review-rating" class="w-full px-3 py-2 border rounded" min="1" max="5" required></div>
                                    <div><label class="block font-semibold">Review Text</label><textarea id="review-text" rows="3" class="w-full px-3 py-2 border rounded" required></textarea></div>
                                    <div><label class="block font-semibold">User Image URL</label><input type="url" id="review-imageUrl" class="w-full px-3 py-2 border rounded" required></div>
                                    <button type="submit" class="w-full btn btn-primary">Add Review</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                             <div class="bg-white shadow-md rounded-lg overflow-x-auto">
                                <table class="min-w-full">
                                    <thead><tr><th>User Name</th><th>Rating</th><th>Review</th><th>Date</th><th>Actions</th></tr></thead>
                                    <tbody id="reviews-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="support-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Manage Support Links</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4" id="support-form-title">Add New Support Link</h2>
                                <form id="support-form" class="space-y-4">
                                    <input type="hidden" id="support-id">
                                    <div><label class="block font-semibold">Channel Name</label><input type="text" id="support-name" class="w-full px-3 py-2 border rounded" placeholder="e.g., Telegram Support" required></div>
                                    <div><label class="block font-semibold">Icon URL</label><input type="url" id="support-iconUrl" class="w-full px-3 py-2 border rounded" placeholder="https://i.postimg.cc/....png" required></div>
                                    <div><label class="block font-semibold">Link URL</label><input type="url" id="support-link" class="w-full px-3 py-2 border rounded" placeholder="https://t.me/username" required></div>
                                    <div><label class="block font-semibold">Order</label><input type="number" id="support-order" class="w-full px-3 py-2 border rounded" value="0"></div>
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox" id="support-isActive" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                                        <label for="support-isActive" class="font-semibold">Is Active</label>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button type="submit" id="support-submit-btn" class="w-full btn btn-primary">Save Link</button>
                                        <button type="button" id="support-cancel-btn" class="w-full btn bg-gray-300 hidden">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <div class="stat-card p-6">
                                <h2 class="text-xl font-bold mb-4">Current Support Links</h2>
                                <div id="support-links-list" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="settings-page" class="page">
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">App Settings</h1>
                    <div class="space-y-8">
                        <div class="stat-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Mail Shop Items</h2>
                                <button id="add-mail-type-btn" class="btn btn-primary">Add New Mail Type</button>
                            </div>
                            <p class="text-sm text-gray-500 mb-4">এখানে আপনার অ্যাপে বিক্রি হওয়া প্রতিটি মেইল আইটেম যোগ করুন। সকল তথ্য সঠিকভাবে দিন।</p>
                            <div id="mail-types-container" class="space-y-6"></div>
                        </div>
                        <div class="stat-card p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Homepage Ads</h2>
                                <button id="add-ad-btn" class="btn btn-primary">Add New Ad</button>
                            </div>
                             <div class="mb-4">
                                <label class="block font-semibold mb-2">Ad Carousel Interval (seconds)</label>
                                <input type="number" id="ads-interval" class="w-full max-w-xs p-2 border rounded-md" placeholder="e.g., 5">
                            </div>
                            <div id="ads-container" class="space-y-4"></div>
                        </div>
                    </div>
                    <div class="mt-8">
                        <button id="save-all-settings-btn" class="w-full lg:w-auto btn btn-primary px-8 py-3 text-lg">Save All Settings</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="balance-modal" class="modal-overlay hidden">
        <div class="modal-content !w-[500px]">
            <h2 id="balance-modal-title" class="text-2xl font-bold mb-6">Update Balance</h2>
            <form id="balance-form" class="space-y-4">
                <input type="hidden" id="balance-user-id">
                <p class="text-lg">Current Balance: <span id="current-balance-display" class="font-bold"></span></p>
                <div>
                    <label class="block font-semibold">Action</label>
                    <select id="balance-action" class="w-full p-2 border rounded">
                        <option value="add">Add to Balance</option>
                        <option value="deduct">Deduct from Balance</option>
                        <option value="set">Set New Balance</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold">Amount (BDT)</label>
                    <input type="number" id="balance-amount" step="0.01" class="w-full p-2 border rounded" required>
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="balance-modal-cancel" class="btn bg-gray-300">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Balance</button>
                </div>
            </form>
        </div>
    </div>
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="alert-message" class="mb-4 text-gray-800"></p><button id="alert-ok-btn" class="btn btn-primary px-6">OK</button></div></div>
    <div id="custom-confirm" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><p id="confirm-message" class="mb-6 text-gray-800"></p><div class="flex justify-center space-x-4"><button id="confirm-cancel-btn" class="btn bg-gray-300 text-gray-800 px-6">Cancel</button><button id="confirm-ok-btn" class="btn btn-danger px-6">Confirm</button></div></div></div>
    
    <script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyABzUFAkmkbYmaEPC1mpAIM3TWnG_NkxU0",
  authDomain: "backup-mail-store.firebaseapp.com",
  projectId: "backup-mail-store",
  storageBucket: "backup-mail-store.firebasestorage.app",
  messagingSenderId: "856776939573",
  appId: "1:856776939573:web:0f8b852e4028249b5ff97c"
};
        
        const ADMIN_UIDS = ["CUb4r6eg1RV6Ljkj5U2V1cSswng1"]; // গুরুত্বপূর্ণ: এখানে আপনার আসল অ্যাডমিন Firebase UID দিন

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, query, where, onSnapshot, addDoc, serverTimestamp, deleteDoc, writeBatch, getDocs, runTransaction, orderBy, limit, getCountFromServer, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard');
        let appConfig = {};
        let userChart = null;
        let depositUnsubscribe = null;
        
        // --- Initialization ---
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, (user) => {
                if (user && ADMIN_UIDS.includes(user.uid)) {
                    loginView.style.display = 'none';
                    dashboardView.style.display = 'block';
                    navigateTo('dashboard-page');
                } else {
                    if (user) signOut(auth);
                    loginView.style.display = 'flex';
                    dashboardView.style.display = 'none';
                }
            });
        };
        
        // --- Navigation & Page Loading ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId)?.classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            
            if (depositUnsubscribe) { depositUnsubscribe(); depositUnsubscribe = null; }

            const pageFunctions = {
                'dashboard-page': loadDashboardData,
                'users-page': () => loadUsers(),
                'notifications-page': () => {},
                'deposits-page': loadDeposits,
                'recharge-page': loadRechargeRequests,
                'purchases-page': loadMailPurchases,
                'stock-page': loadAddStockPage,
                'manage-mails-page': loadManageMailsPage,
                'updates-page': loadUpdates,
                'tutorials-page': loadTutorials,
                'reviews-page': loadUserReviews,
                'settings-page': loadSettings,
                'support-page': loadSupportLinks,
            };
            pageFunctions[pageId]?.();
            lucide.createIcons();
        }

        async function fetchAppConfig() {
            try {
                const configRef = doc(db, "config", "main");
                const docSnap = await getDoc(configRef);
                appConfig = docSnap.exists() ? docSnap.data() : { mails: [], ads: { items: [], intervalSeconds: 5 } };
                if (!appConfig.mails) appConfig.mails = [];
                if (!appConfig.ads) appConfig.ads = { items: [], intervalSeconds: 5 };
                return appConfig;
            } catch (error) {
                console.error("Error fetching app config:", error);
                showAlert("Could not load app configuration.");
                return { mails: [], ads: { items: [], intervalSeconds: 5 } };
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('user-search').addEventListener('input', (e) => loadUsers(e.target.value));
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(link.dataset.page); });
            });
            document.getElementById('send-broadcast-btn').addEventListener('click', handleBroadcastNotification);
            document.getElementById('send-direct-btn').addEventListener('click', handleDirectNotification);
            document.getElementById('update-form').addEventListener('submit', handleUpdateSubmit);
            document.getElementById('update-cancel-btn').addEventListener('click', resetUpdateForm);
            document.getElementById('save-all-settings-btn').addEventListener('click', saveAllSettings);
            document.getElementById('add-mail-type-btn').addEventListener('click', () => addMailTypeToUI());
            document.getElementById('add-ad-btn').addEventListener('click', () => addAdToUI());
            document.getElementById('add-mails-btn').addEventListener('click', handleAddMails);
            document.getElementById('balance-modal-cancel').addEventListener('click', () => document.getElementById('balance-modal').classList.add('hidden'));
            document.getElementById('balance-form').addEventListener('submit', handleBalanceUpdate);
            document.getElementById('tutorial-form').addEventListener('submit', handleTutorialFormSubmit);
            document.getElementById('tutorial-cancel-btn').addEventListener('click', resetTutorialForm);
            document.getElementById('review-form').addEventListener('submit', handleAddReview);
            document.getElementById('mail-type-select-manage').addEventListener('change', (e) => fetchAndDisplayMails(e.target.value));
            document.getElementById('alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
            document.getElementById('support-form').addEventListener('submit', handleSupportFormSubmit);
            document.getElementById('support-cancel-btn').addEventListener('click', resetSupportForm);
        }

        // --- Authentication ---
        async function handleAdminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            if(!email || !password) return showAlert('Please enter email and password.');
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (!ADMIN_UIDS.includes(userCredential.user.uid)) {
                    await signOut(auth);
                    showAlert("You are not authorized to access this panel.");
                }
            } catch (error) { showAlert("Login failed: " + error.message); }
        }
        
        // --- Dashboard Logic ---
        async function loadDashboardData() {
            const usersColl = collection(db, "users");
            const usersCountSnap = await getCountFromServer(usersColl);
            document.getElementById('total-users').textContent = usersCountSnap.data().count;
            const depositsColl = collection(db, "deposits");
            const pendingDepositsSnap = await getCountFromServer(query(depositsColl, where("status", "==", "pending")));
            document.getElementById('pending-deposits').textContent = pendingDepositsSnap.data().count;
            const approvedDepositsSnap = await getDocs(query(depositsColl, where("status", "==", "approved")));
            const totalDepositAmount = approvedDepositsSnap.docs.reduce((sum, doc) => sum + doc.data().amount, 0);
            document.getElementById('total-deposits-amount').textContent = `৳${totalDepositAmount.toLocaleString()}`;
            const rechargesColl = collection(db, "recharge_requests");
            const pendingRechargesSnap = await getCountFromServer(query(rechargesColl, where("status", "==", "pending")));
            document.getElementById('pending-recharges').textContent = pendingRechargesSnap.data().count;
            const soldMailsColl = collection(db, "mail_purchases");
            const soldMailsCountSnap = await getCountFromServer(soldMailsColl);
            document.getElementById('total-mails-sold').textContent = soldMailsCountSnap.data().count;
            loadStockOverview();
            loadDashboardChart();
        }

        async function loadStockOverview() {
            const container = document.getElementById('stock-overview-container');
            container.innerHTML = `<p>Loading stock data...</p>`;
            await fetchAppConfig();
            if (!appConfig.mails || appConfig.mails.length === 0) {
                container.innerHTML = `<p>No mail types configured in settings.</p>`;
                return;
            }
            const stockPromises = appConfig.mails.map(async (mail) => {
                try {
                    const stockQuery = query(collection(db, mail.stockKey), where("isSold", "==", false));
                    const snapshot = await getCountFromServer(stockQuery);
                    return { name: mail.type, count: snapshot.data().count };
                } catch (e) {
                    console.warn(`Could not fetch stock for ${mail.stockKey}. It might not exist or need an index.`);
                    return { name: mail.type, count: 'Error' };
                }
            });
            const stockCounts = await Promise.all(stockPromises);
            container.innerHTML = stockCounts.map(stock => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-md">
                    <span class="font-semibold text-gray-700">${stock.name}</span>
                    <span class="font-bold text-lg ${stock.count > 10 ? 'text-green-600' : 'text-red-600'}">${stock.count} pcs</span>
                </div>
            `).join('');
        }
        
        async function loadDashboardChart() {
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const q = query(collection(db, "users"), where("createdAt", ">=", sevenDaysAgo));
            const snapshot = await getDocs(q);
            const dailyCounts = {};
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                dailyCounts[d.toISOString().split('T')[0]] = 0;
            }
            snapshot.forEach(doc => {
                const createdAt = doc.data().createdAt;
                if (createdAt && createdAt.toDate) {
                    const regDate = createdAt.toDate().toISOString().split('T')[0];
                    if (dailyCounts[regDate] !== undefined) dailyCounts[regDate]++;
                }
            });
            const labels = Object.keys(dailyCounts);
            const data = Object.values(dailyCounts);
            const ctx = document.getElementById('user-chart').getContext('2d');
            if(userChart) userChart.destroy();
            userChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'New Users', data, borderColor: '#2563eb', backgroundColor: 'rgba(37, 99, 235, 0.1)', fill: true, tension: 0.3 }] }, options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } } });
        }

        // --- User Management ---
        async function loadUsers(searchTerm = '') {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
            const snapshot = await getDocs(query(collection(db, "users"), orderBy("createdAt", "desc")));
            let users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                users = users.filter(user => 
                    (user.name || '').toLowerCase().includes(term) || 
                    (user.tgChatId || '').includes(term)
                );
            }
            renderUsers(users);
        }

        function renderUsers(users) {
            const tableBody = document.getElementById('users-table-body');
            if (users.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No users found.</td></tr>`; return; }
            tableBody.innerHTML = users.map(user => {
                const isBlocked = user.isBlocked || false;
                const hasPin = !!user.pin;
                const userDataString = JSON.stringify({ id: user.id, name: user.name || 'N/A', balance: user.balance || 0 }).replace(/"/g, "'");
                return `<tr>
                    <td>${user.name || 'N/A'}</td><td>${user.tgChatId}</td>
                    <td>৳${(user.balance || 0).toFixed(2)}</td>
                    <td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${hasPin ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${hasPin ? 'Set' : 'Not Set'}</span></td>
                    <td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isBlocked ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${isBlocked ? 'Blocked' : 'Active'}</span></td>
                    <td class="space-x-2 whitespace-nowrap">
                        <button class="btn text-xs ${isBlocked ? 'btn-success' : 'btn-danger'}" onclick="window.toggleBlockUser('${user.id}', ${isBlocked})">${isBlocked ? 'Unblock' : 'Block'}</button>
                        <button class="btn text-xs btn-primary" onclick="window.openBalanceModal(${userDataString})">Balance</button>
                        <button class="btn text-xs bg-yellow-500 text-white" onclick="window.resetUserPin('${user.id}')">Reset PIN</button>
                    </td></tr>`;
            }).join('');
        }

        window.toggleBlockUser = (userId, isBlocked) => {
            const action = isBlocked ? 'unblock' : 'block';
            showConfirm(`Are you sure you want to ${action} this user?`, async () => {
                await updateDoc(doc(db, "users", userId), { isBlocked: !isBlocked });
                showAlert(`User successfully ${action}ed.`);
                loadUsers(document.getElementById('user-search').value);
            });
        };
        
        window.resetUserPin = (userId) => {
            showConfirm(`Are you sure you want to reset this user's PIN?`, async () => {
                await updateDoc(doc(db, "users", userId), { pin: null, featuresLockedUntil: null, pinFailAttempts: [] });
                showAlert(`User's PIN has been reset and account unlocked.`);
                loadUsers(document.getElementById('user-search').value);
            });
        };

        window.openBalanceModal = (userData) => {
            document.getElementById('balance-user-id').value = userData.id;
            document.getElementById('balance-modal-title').textContent = `Update Balance for ${userData.name}`;
            document.getElementById('current-balance-display').textContent = `৳${(userData.balance || 0).toFixed(2)}`;
            document.getElementById('balance-form').reset();
            document.getElementById('balance-modal').classList.remove('hidden');
        };

        async function handleBalanceUpdate(e) {
            e.preventDefault();
            const userId = document.getElementById('balance-user-id').value;
            const action = document.getElementById('balance-action').value;
            const amount = parseFloat(document.getElementById('balance-amount').value);
            if (isNaN(amount) || amount < 0) return showAlert("Please enter a valid amount.");
            const userRef = doc(db, "users", userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw new Error("User not found.");
                    const currentBalance = userDoc.data().balance || 0;
                    let newBalance = (action === 'add') ? currentBalance + amount : (action === 'deduct') ? currentBalance - amount : amount;
                    if (newBalance < 0) newBalance = 0; // Prevent negative balance
                    transaction.update(userRef, { balance: newBalance });
                });
                showAlert("User balance updated successfully.");
                document.getElementById('balance-modal').classList.add('hidden');
                loadUsers(document.getElementById('user-search').value);
            } catch (error) { showAlert("Failed to update balance: " + error.message); }
        }
        
        // --- Requests Management (Deposits, Recharges) ---
        function loadDeposits() {
            const tableBody = document.getElementById('deposits-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`;
            const q = query(collection(db, "deposits"), where("status", "==", "pending"), orderBy("requestedAt", "desc"));
            
            depositUnsubscribe = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No pending deposits.</td></tr>`;
                    return;
                }
                tableBody.innerHTML = snapshot.docs.map(docSnap => {
                    const req = docSnap.data();
                    return `<tr>
                        <td>${req.userName || 'N/A'}</td><td>৳${req.amount}</td><td>${req.method}</td>
                        <td>${req.senderNumber}</td><td>${req.transactionId}</td>
                        <td>${req.requestedAt?.toDate().toLocaleString() || 'N/A'}</td>
                        <td class="space-x-2">
                            <button class="btn btn-success text-xs" onclick="window.handleDeposit('${docSnap.id}', '${req.userId}', ${req.amount}, 'approved')">Approve</button>
                            <button class="btn btn-danger text-xs" onclick="window.handleDeposit('${docSnap.id}', null, 0, 'rejected')">Reject</button>
                        </td></tr>`;
                }).join('');
            }, (error) => {
                console.error("Error fetching deposits:", error);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500">Error loading deposits.</td></tr>`;
            });
        }
        
        window.handleDeposit = (depositId, userId, amount, newStatus) => {
            showConfirm(`Are you sure you want to ${newStatus} this ৳${amount} deposit?`, async () => {
                const depositRef = doc(db, "deposits", depositId);
                const userRef = userId ? doc(db, "users", userId) : null;
                try {
                    await runTransaction(db, async (transaction) => {
                        if (newStatus === 'approved' && userRef) {
                            transaction.update(userRef, { balance: increment(amount) });
                        }
                        transaction.update(depositRef, { status: newStatus, processedAt: serverTimestamp() });
                    });
                    showAlert(`Deposit has been ${newStatus}.`);
                } catch (e) { showAlert("Operation failed: " + e.message); }
            });
        };
        
        async function loadRechargeRequests() {
            const tableBody = document.getElementById('recharge-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`;
            const q = query(collection(db, "recharge_requests"), where("status", "==", "pending"), orderBy("requestedAt", "desc"));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) { tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No pending recharge requests.</td></tr>`; return; }
                tableBody.innerHTML = snapshot.docs.map(docSnap => {
                    const req = docSnap.data();
                    return `<tr>
                        <td>${req.userName || 'N/A'}</td><td>৳${req.amount.toFixed(2)}</td>
                        <td>${req.mobileNumber}</td><td>${req.operator}</td><td>${req.rechargeType}</td>
                        <td>${req.requestedAt?.toDate().toLocaleString() || 'N/A'}</td>
                        <td class="space-x-2">
                            <button class="btn btn-success text-xs" onclick="window.handleRecharge('${docSnap.id}', 'approved')">Approve</button>
                            <button class="btn btn-danger text-xs" onclick="window.handleRecharge('${docSnap.id}', 'rejected', '${req.userId}', ${req.totalDeducted})">Reject</button>
                        </td></tr>`;
                }).join('');
            });
        }
        
        window.handleRecharge = (rechargeId, newStatus, userId = null, refundAmount = 0) => {
            const actionText = newStatus === 'rejected' ? `reject and refund ৳${refundAmount.toFixed(2)}` : `${newStatus} this request`;
            showConfirm(`Are you sure you want to ${actionText}?`, async () => {
                const rechargeRef = doc(db, "recharge_requests", rechargeId);
                try {
                    await runTransaction(db, async (t) => {
                        if (newStatus === 'rejected' && userId && refundAmount > 0) {
                            const userRef = doc(db, "users", userId);
                            t.update(userRef, { balance: increment(refundAmount) });
                        }
                        t.update(rechargeRef, { status: newStatus, processedAt: serverTimestamp() });
                    });
                    showAlert(`Recharge request has been ${newStatus}.`);
                } catch (e) { showAlert("Operation failed: " + e.message); }
            });
        };

        // --- Content Management (Stock, Purchases, Updates, etc.) ---
        async function loadMailPurchases() {
            const tableBody = document.getElementById('purchases-table-body');
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
            const q = query(collection(db, "mail_purchases"), orderBy("purchasedAt", "desc"), limit(100));
            const usersMap = new Map();
            const [purchasesSnap, usersSnap] = await Promise.all([getDocs(q), getDocs(collection(db, "users"))]);
            usersSnap.forEach(doc => usersMap.set(doc.id, doc.data().name || doc.id));
            if (purchasesSnap.empty) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No purchases found.</td></tr>`; return; }
            tableBody.innerHTML = purchasesSnap.docs.map(docSnap => {
                const p = docSnap.data();
                const mailDetails = [p.mail, p.password].filter(Boolean).join(' | ');
                return `<tr>
                    <td>#${p.saleId || 'N/A'}</td>
                    <td>${p.purchasedAt?.toDate().toLocaleString() || 'N/A'}</td>
                    <td>${usersMap.get(p.userId) || p.userId}</td>
                    <td>${p.mailType}</td>
                    <td class="text-xs font-mono">${mailDetails}</td>
                    <td>৳${p.cost.toFixed(2)}</td>
                </tr>`;
            }).join('');
        }
        
        async function loadAddStockPage() {
            await fetchAppConfig();
            const selectEl = document.getElementById('mail-type-select-add');
            selectEl.innerHTML = '<option value="">Select mail type...</option>';
            appConfig.mails.forEach(mail => {
                selectEl.innerHTML += `<option value="${mail.stockKey}">${mail.type}</option>`;
            });
        }
        
        async function handleAddMails() {
            const stockKey = document.getElementById('mail-type-select-add').value;
            const mailDataRaw = document.getElementById('mail-data-textarea').value;
            if (!stockKey || !mailDataRaw.trim()) return showAlert("Please select a mail type and provide mail data.");
            const lines = mailDataRaw.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return showAlert("No valid mail data found.");
            
            const batch = writeBatch(db);
            let addedCount = 0;
            lines.forEach(line => {
                const parts = line.trim().split('/');
                if (parts.length >= 2) {
                    const mailDocRef = doc(collection(db, stockKey));
                    batch.set(mailDocRef, { email: parts[0], password: parts[1], refresh_token: parts[2] || '', client_id: parts[3] || '', isSold: false, createdAt: serverTimestamp() });
                    addedCount++;
                }
            });
            if (addedCount > 0) {
                await batch.commit();
                showAlert(`Successfully added ${addedCount} new mails to the '${stockKey}' stock.`);
                document.getElementById('mail-data-textarea').value = '';
            } else {
                showAlert("No valid mails were found. Check the format.");
            }
        }
        
        async function loadManageMailsPage() {
            await fetchAppConfig();
            const selectEl = document.getElementById('mail-type-select-manage');
            selectEl.innerHTML = '<option value="">Select mail type to view...</option>';
            appConfig.mails.forEach(mail => {
                selectEl.innerHTML += `<option value="${mail.stockKey}">${mail.type}</option>`;
            });
            document.getElementById('individual-mails-container').innerHTML = '<p class="text-gray-500">Please select a mail type to see the available stock.</p>';
        }

        async function fetchAndDisplayMails(stockKey) {
            const container = document.getElementById('individual-mails-container');
            if (!stockKey) {
                container.innerHTML = '<p class="text-gray-500">Please select a mail type.</p>';
                return;
            }
            container.innerHTML = 'Loading mails...';

            try {
                const q = query(collection(db, stockKey), where("isSold", "==", false));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    container.innerHTML = `<p class="text-gray-500">No unsold mails found for this type.</p>`;
                    return;
                }

                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toDate() || 0;
                    const timeB = b.data().createdAt?.toDate() || 0;
                    return timeB - timeA; // Descending order
                });

                const buttonsHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <button class="btn btn-primary" onclick="window.copyAllUnsold('${stockKey}')"><i data-lucide="copy" class="inline-block w-4 h-4 mr-1"></i>Copy All (${snapshot.size})</button>
                        <button class="btn btn-danger" onclick="window.deleteAllUnsold('${stockKey}')"><i data-lucide="trash-2" class="inline-block w-4 h-4 mr-1"></i>Delete All (${snapshot.size})</button>
                    </div>`;
                
                const tableHTML = `
                    <table class="min-w-full">
                        <thead><tr><th>Email</th><th>Password</th><th>Added On</th><th>Actions</th></tr></thead>
                        <tbody>${sortedDocs.map(doc => `
                            <tr>
                                <td class="font-mono text-xs">${doc.data().email}</td>
                                <td class="font-mono text-xs">${doc.data().password}</td>
                                <td>${doc.data().createdAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                                <td><button class="btn btn-danger text-xs" onclick="window.deleteMail('${stockKey}', '${doc.id}')">Delete</button></td>
                            </tr>
                        `).join('')}</tbody>
                    </table>`;

                container.innerHTML = buttonsHTML + tableHTML;
                lucide.createIcons();

            } catch (error) {
                console.error("Error fetching mails:", error);
                container.innerHTML = `
                    <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                        <p class="font-bold">Error loading mails!</p>
                        <p class="text-sm mt-1">This usually happens because a Firestore index is missing. Please create the required index in your Firebase console.</p>
                        <p class="text-xs mt-2 font-mono"><strong>Error Details:</strong> ${error.message}</p>
                    </div>`;
            }
        }
        
        // +++ START: ADDED/FIXED FUNCTIONS +++
        async function deleteMail(stockKey, docId) {
            showConfirm("Are you sure you want to delete this mail?", async () => {
                try {
                    await deleteDoc(doc(db, stockKey, docId));
                    showAlert("Mail deleted successfully.");
                    fetchAndDisplayMails(stockKey); // Refresh the list
                } catch (error) {
                    showAlert("Error deleting mail: " + error.message);
                }
            });
        }

        async function deleteAllUnsold(stockKey) {
            showConfirm("Are you sure you want to delete ALL unsold mails of this type? This action cannot be undone.", async () => {
                try {
                    const q = query(collection(db, stockKey), where("isSold", "==", false));
                    const snapshot = await getDocs(q);
                    if (snapshot.empty) {
                        showAlert("No unsold mails to delete.");
                        return;
                    }

                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    showAlert(`Successfully deleted ${snapshot.size} mails.`);
                    fetchAndDisplayMails(stockKey); // Refresh the list
                } catch (error) {
                    showAlert("Error deleting all mails: " + error.message);
                }
            });
        }
        
        async function copyAllUnsold(stockKey) {
            try {
                const q = query(collection(db, stockKey), where("isSold", "==", false));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showAlert("No unsold mails to copy.");
                    return;
                }

                const mailList = snapshot.docs.map(doc => `${doc.data().email}:${doc.data().password}`).join('\n');
                
                await navigator.clipboard.writeText(mailList);
                showAlert(`Copied ${snapshot.size} mails to clipboard.`);

            } catch (error) {
                showAlert("Could not copy to clipboard: " + error.message);
                console.error("Clipboard copy failed:", error);
            }
        }
        // +++ END: ADDED/FIXED FUNCTIONS +++

        async function handleBroadcastNotification() {
            const title = document.getElementById('broadcast-title').value;
            const message = document.getElementById('broadcast-message').value;
            if (!title || !message) return showAlert("Title and message are required for broadcast.");
            await addDoc(collection(db, 'notifications'), { title, message, createdAt: serverTimestamp() });
            showAlert("Broadcast notification sent successfully!");
            document.getElementById('broadcast-title').value = '';
            document.getElementById('broadcast-message').value = '';
        }
        
        async function handleDirectNotification() {
            const userId = document.getElementById('direct-user-id').value;
            const title = document.getElementById('direct-title').value;
            const message = document.getElementById('direct-message').value;
            if (!userId || !title || !message) return showAlert("User ID, title, and message are required.");
            const userDoc = await getDoc(doc(db, "users", userId));
            if (!userDoc.exists()) return showAlert(`User with ID ${userId} not found.`);
            const finalMessage = `${message}`;
            await addDoc(collection(db, 'notifications'), { title, message: finalMessage, toUserId: userId, createdAt: serverTimestamp() });
            showAlert(`Direct notification sent to user ${userId}.`);
            document.getElementById('direct-user-id').value = '';
            document.getElementById('direct-title').value = '';
            document.getElementById('direct-message').value = '';
        }

        async function loadUpdates() { /* Stub */ }
        async function handleUpdateSubmit(e) { e.preventDefault(); /* Stub */ }
        function resetUpdateForm() { /* Stub */ }
        async function loadTutorials() { /* Stub */ }
        async function handleTutorialFormSubmit(e) { e.preventDefault(); /* Stub */ }
        function resetTutorialForm() { /* Stub */ }
        
        function loadUserReviews() {
            const tableBody = document.getElementById('reviews-table-body');
            onSnapshot(query(collection(db, "reviews"), orderBy("createdAt", "desc")), (snapshot) => {
                if(snapshot.empty) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No reviews found.</td></tr>`; return; }
                tableBody.innerHTML = snapshot.docs.map(doc => {
                    const r = {id: doc.id, ...doc.data()};
                    return `<tr>
                        <td>${r.name || 'N/A'}</td><td>${'⭐'.repeat(r.rating)}</td>
                        <td>${r.reviewText}</td>
                        <td>${r.createdAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                        <td><button class="btn btn-danger text-xs" onclick="window.deleteReview('${r.id}')">Delete</button></td>
                    </tr>`;
                }).join('');
            });
        }
        
        async function handleAddReview(e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('review-name').value,
                rating: parseInt(document.getElementById('review-rating').value),
                reviewText: document.getElementById('review-text').value,
                imageUrl: document.getElementById('review-imageUrl').value,
                createdAt: serverTimestamp()
            };
            if (!data.name || !data.rating || !data.reviewText || !data.imageUrl) {
                return showAlert("Please fill all review fields.");
            }
            await addDoc(collection(db, "reviews"), data);
            showAlert("Review added successfully!");
            document.getElementById('review-form').reset();
        }

        window.deleteReview = (id) => showConfirm("Delete this review?", async () => await deleteDoc(doc(db, "reviews", id)));
        
        // --- Settings Page Logic ---
        async function loadSettings() {
            await fetchAppConfig();
            const mailTypesContainer = document.getElementById('mail-types-container');
            mailTypesContainer.innerHTML = '';
            appConfig.mails.forEach((mail) => addMailTypeToUI(mail));
            
            const adsContainer = document.getElementById('ads-container');
            adsContainer.innerHTML = '';
            document.getElementById('ads-interval').value = appConfig.ads.intervalSeconds || 5;
            (appConfig.ads.items || []).forEach((ad) => addAdToUI(ad));
            lucide.createIcons();
        }

        function addMailTypeToUI(mail = {}) {
            const container = document.getElementById('mail-types-container');
            const card = document.createElement('div');
            card.className = 'p-4 border-2 border-dashed rounded-lg bg-gray-50 mail-type-card';
            card.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" placeholder="Type (e.g., Google)" class="p-2 border rounded" data-field="type" value="${mail.type || ''}" required>
                    <input type="number" step="0.01" placeholder="Price (BDT)" class="p-2 border rounded" data-field="priceBdt" value="${mail.priceBdt || ''}" required>
                    <input type="number" placeholder="Expiration (Hours, optional)" class="p-2 border rounded" data-field="expirationDays" value="${mail.expirationDays || ''}">
                    <input type="text" placeholder="Stock Key (e.g., google_mails)" class="p-2 border rounded" data-field="stockKey" value="${mail.stockKey || ''}" required>
                    <input type="url" placeholder="Logo URL" class="p-2 border rounded" data-field="logoUrl" value="${mail.logoUrl || ''}" required>
                    <input type="url" placeholder="API Link (Optional)" class="p-2 border rounded" data-field="apiLink" value="${mail.apiLink || ''}">
                    <textarea placeholder="Details/Description" class="p-2 border rounded md:col-span-3" data-field="details" rows="2">${mail.details || ''}</textarea>
                </div>
                <button class="btn btn-danger mt-4 text-xs" onclick="this.parentElement.remove()">Remove</button>`;
            container.appendChild(card);
        }

        function addAdToUI(ad = {}) {
            const container = document.getElementById('ads-container');
            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg bg-gray-50 ad-card';
            card.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="url" placeholder="Image URL" class="p-2 border rounded" data-field="imageUrl" value="${ad.imageUrl || ''}">
                    <input type="url" placeholder="Link URL" class="p-2 border rounded" data-field="linkUrl" value="${ad.linkUrl || ''}">
                </div><button class="btn btn-danger mt-4 text-xs" onclick="this.parentElement.remove()">Remove</button>`;
            container.appendChild(card);
        }

        async function saveAllSettings() {
            showConfirm("Are you sure you want to save all settings?", async () => {
                const newConfig = { mails: [], ads: { items: [], intervalSeconds: 5 } };
                
                document.querySelectorAll('.mail-type-card').forEach(card => {
                    const mail = {};
                    card.querySelectorAll('[data-field]').forEach(input => {
                        const field = input.dataset.field;
                        let value = input.value.trim();
                        if (field === 'priceBdt') value = parseFloat(value) || 0;
                        if (field === 'expirationDays') value = value ? parseInt(value) : null;
                        mail[field] = value;
                    });
                    if (mail.type && mail.stockKey && mail.priceBdt > 0 && mail.logoUrl) {
                        newConfig.mails.push(mail);
                    } else {
                        console.warn("Skipping invalid mail item:", mail);
                    }
                });
                
                document.querySelectorAll('.ad-card').forEach(card => {
                    const ad = {};
                    card.querySelectorAll('[data-field]').forEach(input => ad[input.dataset.field] = input.value.trim());
                    if (ad.imageUrl && ad.linkUrl) newConfig.ads.items.push(ad);
                });
                newConfig.ads.intervalSeconds = parseInt(document.getElementById('ads-interval').value) || 5;
                
                await setDoc(doc(db, "config", "main"), newConfig);
                showAlert("All settings saved successfully!");
            });
        }
        
        // --- Support Links Management ---
        async function loadSupportLinks() {
            const listContainer = document.getElementById('support-links-list');
            listContainer.innerHTML = 'Loading...';
            const q = query(collection(db, "support_channels"), orderBy("order"));

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500">No support links found.</p>';
                    return;
                }
                listContainer.innerHTML = snapshot.docs.map(docSnap => {
                    const link = { id: docSnap.id, ...docSnap.data() };
                    const linkDataString = JSON.stringify(link).replace(/"/g, "'");
                    return `<div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg">
                        <div class="flex items-center gap-3">
                            <img src="${link.iconUrl}" class="w-8 h-8 rounded-full object-cover">
                            <div>
                                <p class="font-semibold">${link.name} ${link.isActive ? '' : '<span class=text-red-500>(Inactive)</span>'}</p>
                                <p class="text-xs text-gray-500">Order: ${link.order}</p>
                            </div>
                        </div>
                        <div class="space-x-2">
                           <button class="btn text-xs bg-blue-100 text-blue-800" onclick="window.editSupportLink(${linkDataString})">Edit</button>
                           <button class="btn text-xs btn-danger" onclick="window.deleteSupportLink('${link.id}')">Delete</button>
                        </div>
                    </div>`;
                }).join('');
            });
        }

        async function handleSupportFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('support-id').value;
            const data = {
                name: document.getElementById('support-name').value,
                iconUrl: document.getElementById('support-iconUrl').value,
                link: document.getElementById('support-link').value,
                order: parseInt(document.getElementById('support-order').value) || 0,
                isActive: document.getElementById('support-isActive').checked
            };

            try {
                if (id) {
                    await updateDoc(doc(db, "support_channels", id), data);
                    showAlert("Support link updated successfully!");
                } else {
                    await addDoc(collection(db, "support_channels"), data);
                    showAlert("Support link added successfully!");
                }
                resetSupportForm();
            } catch (error) {
                showAlert("Error saving support link: " + error.message);
            }
        }

        function resetSupportForm() {
            document.getElementById('support-form').reset();
            document.getElementById('support-id').value = '';
            document.getElementById('support-form-title').textContent = "Add New Support Link";
            document.getElementById('support-submit-btn').textContent = "Save Link";
            document.getElementById('support-cancel-btn').classList.add('hidden');
        }

        window.editSupportLink = (linkData) => {
            document.getElementById('support-id').value = linkData.id;
            document.getElementById('support-name').value = linkData.name;
            document.getElementById('support-iconUrl').value = linkData.iconUrl;
            document.getElementById('support-link').value = linkData.link;
            document.getElementById('support-order').value = linkData.order;
            document.getElementById('support-isActive').checked = linkData.isActive;
            document.getElementById('support-form-title').textContent = "Edit Support Link";
            document.getElementById('support-submit-btn').textContent = "Update Link";
            document.getElementById('support-cancel-btn').classList.remove('hidden');
            window.scrollTo(0, 0);
        };

        window.deleteSupportLink = (id) => {
            showConfirm("Are you sure you want to delete this support link?", async () => {
                await deleteDoc(doc(db, "support_channels", id));
                showAlert("Support link deleted.");
            });
        };
        
        // --- Utility Functions ---
        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }

        function showConfirm(message, onConfirm) {
            const confirmModal = document.getElementById('custom-confirm');
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const okListener = () => { onConfirm(); cleanup(); };
            const cancelListener = () => cleanup();
            function cleanup() {
                confirmModal.classList.add('hidden');
                okBtn.removeEventListener('click', okListener);
                cancelBtn.removeEventListener('click', cancelListener);
            }
            okBtn.addEventListener('click', okListener, { once: true });
            cancelBtn.addEventListener('click', cancelListener, { once: true });
        }
        
        // --- Make functions globally accessible on the window object ---
        window.toggleBlockUser = toggleBlockUser;
        window.openBalanceModal = openBalanceModal;
        window.resetUserPin = resetUserPin;
        window.handleDeposit = handleDeposit;
        window.handleRecharge = handleRecharge;
        window.deleteReview = deleteReview;
        window.deleteMail = deleteMail;
        window.copyAllUnsold = copyAllUnsold;
        window.deleteAllUnsold = deleteAllUnsold;
        window.editSupportLink = editSupportLink;
        window.deleteSupportLink = deleteSupportLink;

    </script>
</body>
</html>
