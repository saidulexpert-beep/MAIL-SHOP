<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ùêåùêÄùêàùêã ùêíùêìùêéùêëùêÑ</title>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f8f8;
            color: #333333;
            -webkit-user-select: none;
            user-select: none;
            padding-bottom: 80px; /* Space for bottom nav */
        }
        input, textarea, #mail-details-content, .selectable-text {
            -webkit-user-select: text;
            user-select: text;
        }
        .card-bg {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-bg:hover {
            border-color: rgba(0, 123, 255, 0.4);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .text-accent-gradient {
            background: linear-gradient(to right, #007bff, #0056b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-gradient {
            background-image: linear-gradient(to right, #007bff, #0056b3);
            color: #ffffff;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
            transition: all 0.2s;
        }
        .btn-gradient:active { transform: scale(0.98); }
        .input-field {
            background-color: #f0f0f0;
            border: 1px solid #cccccc;
            color: #333333;
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
            outline: none;
        }
        
        /* Page Visibility Logic */
        .sub-page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .sub-page.active { display: block; }

        .bottom-nav {
             border-top: 1px solid #e0e0e0;
             background-color: rgba(255, 255, 255, 0.98);
             position: fixed;
             bottom: 0; left: 0; right: 0;
             max-width: 448px; margin: 0 auto;
             display: flex; justify-content: space-around;
             padding: 10px 0; z-index: 50;
             height: 70px;
             box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }
        .nav-link-native {
            display: flex; flex-direction: column; align-items: center;
            color: #9ca3af; font-size: 0.7rem; font-weight: 600;
            gap: 4px; width: 20%; cursor: pointer;
        }
        .nav-link-native.active { color: #007bff; }
        .nav-link-native .icon { width: 24px; height: 24px; }

        .header-native {
            background-color: #007bff; padding: 0.75rem;
            position: sticky; top: 0; z-index: 40;
            display: flex; align-items: center; justify-content: space-between;
            color: white; gap: 8px;
        }
        .header-btn {
            background: rgba(255,255,255,0.2); border-radius: 8px; padding: 6px;
            display: flex; align-items: center; justify-content: center;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loader */
        #loader { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem; z-index: 100; background: #f8f8f8; }
        .premium-loader-spinner {
            width: 50px; height: 50px; border-radius: 50%;
            background: conic-gradient(#0000 10%, #007bff);
            -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0);
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(1turn); } }
        
        /* Banner */
        .banner-wrapper { position: relative; padding-top: 50%; border-radius: 12px; overflow: hidden; }
        .banner-inner { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; transition: transform 0.5s ease; }
        .slide { min-width: 100%; }
        .slide img { width: 100%; height: 100%; object-fit: cover; }
        
        .modal-close-btn { position: absolute; top: 12px; right: 12px; padding: 5px; border-radius: 50%; background: #f3f4f6; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen flex flex-col">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0">
        <div class="premium-loader-spinner"></div>
        <h1 class="text-accent-gradient font-bold text-xl animate-pulse">ùêåùêÄùêàùêã ùêíùêìùêéùêëùêÑ</h1>
    </div>

    <!-- Header -->
    <header class="header-native">
        <div id="header-profile-area" class="flex items-center gap-2 cursor-pointer" onclick="navigateTo('profile-page')">
            <img id="header-profile-pic" class="w-8 h-8 rounded-full border border-white bg-gray-200 object-cover hidden" src="" alt="">
            <div id="header-initials-avatar" class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center border border-white text-xs font-bold">U</div>
        </div>

        <button id="header-deposit-btn" class="header-btn" onclick="navigateTo('pay-page')"><i data-lucide="plus" class="w-5 h-5 text-white"></i></button>

        <div id="header-balance-area" class="bg-white/20 rounded-full px-3 py-1 flex items-center gap-1 cursor-pointer flex-grow justify-center" onclick="navigateTo('withdraw-page')">
            <i data-lucide="circle-dollar-sign" class="w-4 h-4 text-yellow-300"></i>
            <span id="header-coin-balance" class="font-bold text-sm text-white">0.00</span>
        </div>

        <div class="relative">
            <button id="header-notif-btn" class="header-btn" onclick="navigateTo('notification-page')"><i data-lucide="bell" class="w-5 h-5 text-white"></i></button>
            <div id="notif-dot" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-blue-500 hidden"></div>
        </div>
        
        <button id="header-menu-btn" class="header-btn"><i data-lucide="layout-grid" class="w-5 h-5 text-white"></i></button>
    </header>

    <main class="flex-grow p-4 space-y-4 relative">
        
        <!-- HOME PAGE -->
        <div id="home-page" class="sub-page active">
            <div class="banner-wrapper mb-4 shadow-md">
                <div class="banner-inner" id="slides">
                     <div class="slide"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://i.postimg.cc/zBp8rCX9/Yellow-Orange-Modern-Marketing-Courses-You-Tube-Thumbnail-20250910-185659-0000.png" alt="Slide 1"></a></div>
                    <div class="slide"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://i.postimg.cc/W1syFD8p/Grey-Blue-Illustration-Refer-a-Friend-Instagram-Post-1080-x-720-px-20250917-223749-0000.png" alt="Slide 2"></a></div>
                    <div class="slide"><a href="https://t.me/EXPERTearn_team" target="_blank"><img src="https://i.postimg.cc/52HsFwvV/Black-and-Orange-Money-You-Tube-Thumbnail-20250917-224706-0000.png" alt="Slide 3"></a></div>
                </div>
            </div>

            <div class="card-bg p-5 rounded-xl mb-4">
                <p class="text-gray-600 text-sm mb-1">Total Balance</p>
                <div class="flex items-center justify-between">
                    <p id="balance-display" class="text-4xl font-bold text-gray-800">‡ß≥0.00</p>
                    <button onclick="navigateTo('pay-page')" class="btn-gradient px-6 py-2 rounded-lg text-sm">Deposit</button>
                </div>
            </div>
        </div>

        <!-- EARN PAGE -->
        <div id="earn-page" class="sub-page space-y-4">
            <h2 class="text-2xl font-bold text-center text-accent-gradient mb-4">Start Earning</h2>
            
            <!-- Naval Coin -->
            <div class="card-bg p-4 rounded-xl flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center text-amber-600"><i data-lucide="coins" class="w-5 h-5"></i></div>
                    <div><h3 class="font-bold text-gray-800">NAVAL COIN</h3><p class="text-xs text-gray-500">Sell & Earn</p></div>
                </div>
                <button onclick="navigateTo('naval-coin-page')" class="btn-gradient px-5 py-2 rounded-lg text-xs">SELL</button>
            </div>

            <!-- Instagram -->
            <div class="card-bg p-4 rounded-xl flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-pink-600"><i data-lucide="instagram" class="w-5 h-5"></i></div>
                    <div><h3 class="font-bold text-gray-800">INSTAGRAM</h3><p class="text-xs text-gray-500">Sell Account</p></div>
                </div>
                <button onclick="navigateTo('instagram-sell-page')" class="btn-gradient px-5 py-2 rounded-lg text-xs">SELL</button>
            </div>
            
            <!-- Manual Earn (New) -->
            <div class="card-bg p-4 rounded-xl flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i data-lucide="briefcase" class="w-5 h-5"></i></div>
                    <div><h3 class="font-bold text-gray-800">MANUAL EARN</h3><p class="text-xs text-gray-500">Tasks & Jobs</p></div>
                </div>
                <button onclick="showComingSoon()" class="btn-gradient px-5 py-2 rounded-lg text-xs">SELL</button>
            </div>
        </div>
        
        <!-- INSTAGRAM SELL PAGE -->
        <div id="instagram-sell-page" class="sub-page space-y-5">
            <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('earn-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Sell Instagram</h2>
            </div>
            
            <div class="card-bg p-6 rounded-2xl text-center space-y-3">
                <div class="w-16 h-16 mx-auto rounded-full bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 flex items-center justify-center text-white">
                    <i data-lucide="instagram" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-bold" id="insta-sell-price">‡ß≥--</h3>
                <p class="text-sm text-gray-500">Per Account Rate</p>
                <button onclick="document.getElementById('insta-rules-modal').classList.remove('hidden')" class="text-blue-600 text-sm font-semibold underline">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®)</button>
            </div>

            <div class="card-bg p-5 rounded-xl space-y-4">
                <h3 class="font-bold text-gray-700 border-b pb-2">Account Information</h3>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">USERNAME</label>
                    <input type="text" id="insta-username" placeholder="@username" class="w-full p-3 rounded-lg input-field">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">PASSWORD</label>
                    <input type="text" id="insta-password" placeholder="Password" class="w-full p-3 rounded-lg input-field">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">EMAIL (Linked)</label>
                    <input type="email" id="insta-email" placeholder="email@example.com" class="w-full p-3 rounded-lg input-field">
                </div>
                <button id="submit-insta-sell-btn" class="w-full p-3 rounded-lg btn-gradient font-bold mt-2">SELL NOW</button>
                <p class="text-xs text-center text-gray-500 mt-2">‡¶∏‡¶†‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶®‡•§ ‡¶≠‡ßÅ‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶® ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§</p>
            </div>
        </div>

        <!-- NAVAL COIN PAGE (Like Send Page) -->
        <div id="naval-coin-page" class="sub-page space-y-5">
            <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('earn-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Sell Naval Coin</h2>
            </div>
            <div class="card-bg p-5 rounded-xl space-y-5">
                <div>
                    <h3 class="font-semibold text-lg flex items-center gap-2 mb-4"><i data-lucide="coins" class="w-6 h-6 text-amber-500"></i><span>‡¶ï ‡¶ï‡¶Ø‡¶º‡ßá‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßá‡¶®?</span></h3>
                    <p class="text-sm text-center text-blue-600 bg-blue-50 p-2 rounded-lg mb-4">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø‡¶§‡ßá ‡¶ï‡ßü‡ßá‡¶® ‡¶™‡¶æ‡¶†‡¶ø‡ßü‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    
                    <div class="bg-gray-100 p-3 rounded mb-4 text-center">
                        <p class="text-xs text-gray-500">Admin Naval ID</p>
                        <p class="font-mono font-bold text-lg selectable-text" id="admin-naval-id">NAVAL_ADMIN_123</p>
                        <button onclick="copyToClipboard(document.getElementById('admin-naval-id').innerText)" class="text-xs text-blue-600 mt-1">Copy ID</button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Naval ID</label>
                            <input id="naval-sender-id" type="text" placeholder="Sender ID" class="w-full p-3 rounded-lg input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-2">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Amount)</label>
                            <input id="naval-amount" type="number" placeholder="Minimum 100" class="w-full p-3 rounded-lg input-field">
                        </div>
                        <button onclick="handleNavalSell()" class="w-full p-3 rounded-lg btn-gradient">Submit Request</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTIFICATION PAGE (Full Screen) -->
        <div id="notification-page" class="sub-page space-y-4">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('home-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Notifications</h2>
            </div>
            <div id="notification-list" class="space-y-3 pb-20">
                <!-- Content loaded via JS -->
            </div>
        </div>

        <!-- BUY PAGE -->
        <div id="mail-page" class="sub-page space-y-4">
            <h2 class="text-xl font-bold text-gray-800 px-2">Available Products</h2>
            <div id="mail-list-container" class="space-y-4 min-h-[200px] pb-10"></div>
            <div class="pt-4 border-t">
                 <h3 class="text-lg font-semibold px-2 mb-3">Buy History</h3>
                 <div id="mail-purchase-history" class="space-y-3"></div>
            </div>
        </div>

        <!-- PROFILE PAGE -->
        <div id="profile-page" class="sub-page space-y-5">
            <div class="card-bg p-6 rounded-2xl flex flex-col items-center text-center">
                <img id="profile-pic" class="w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover mb-3" src="" alt="">
                <h3 id="profile-name" class="text-2xl font-bold text-gray-800">Loading...</h3>
                <p id="profile-id" class="text-sm text-gray-500 font-mono mt-1">ID: ---</p>
            </div>
            
            <div class="space-y-3">
                <button onclick="navigateTo('features-page')" class="w-full card-bg p-4 rounded-xl flex justify-between items-center font-semibold">
                    <span class="flex items-center gap-3"><i data-lucide="zap" class="text-orange-500"></i> Features (Send/Receive)</span> <i data-lucide="chevron-right" class="text-gray-400"></i>
                </button>
                <button onclick="navigateTo('link-team-page')" class="w-full card-bg p-4 rounded-xl flex justify-between items-center font-semibold">
                    <span class="flex items-center gap-3"><i data-lucide="users" class="text-blue-500"></i> My Team</span> <i data-lucide="chevron-right" class="text-gray-400"></i>
                </button>
                <button onclick="navigateTo('replace-list-page')" class="w-full card-bg p-4 rounded-xl flex justify-between items-center font-semibold">
                    <span class="flex items-center gap-3"><i data-lucide="history" class="text-purple-500"></i> Replace History</span> <i data-lucide="chevron-right" class="text-gray-400"></i>
                </button>
                <button onclick="window.Telegram.WebApp.openTelegramLink('https://t.me/EXPERTearn_team')" class="w-full card-bg p-4 rounded-xl flex justify-between items-center font-semibold">
                    <span class="flex items-center gap-3"><i data-lucide="headphones" class="text-green-500"></i> Support</span> <i data-lucide="chevron-right" class="text-gray-400"></i>
                </button>
            </div>
            
            <!-- Admin Button -->
            <button id="admin-btn" class="hidden w-full btn-gradient p-3 rounded-xl mt-4" onclick="navigateTo('admin-page')">Admin Panel</button>
        </div>

        <!-- DEPOSIT PAGE -->
        <div id="pay-page" class="sub-page space-y-5">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('home-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Deposit</h2>
            </div>
            <div class="card-bg p-5 rounded-2xl space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="border p-3 rounded text-center cursor-pointer hover:border-blue-500" onclick="copyToClipboard('01864260513')">
                        <p class="font-bold text-pink-600">Nagad</p><p class="text-xs text-gray-500">01864260513</p>
                    </div>
                    <div class="border p-3 rounded text-center cursor-pointer hover:border-blue-500" onclick="copyToClipboard('01827750260')">
                        <p class="font-bold text-pink-600">bKash</p><p class="text-xs text-gray-500">01827750260</p>
                    </div>
                </div>
                <p class="text-xs text-center text-gray-500">‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                
                <div class="space-y-3 pt-2">
                     <select id="deposit-method" class="w-full p-3 rounded-lg input-field"><option value="">Method</option><option value="bKash">bKash</option><option value="Nagad">Nagad</option><option value="Binance">Binance</option></select>
                     <input id="deposit-amount" type="number" placeholder="Amount" class="w-full p-3 rounded-lg input-field">
                     <input id="sender-number" type="text" placeholder="Sender Number" class="w-full p-3 rounded-lg input-field">
                     <input id="deposit-txid" type="text" placeholder="TrxID" class="w-full p-3 rounded-lg input-field">
                     <button id="deposit-btn" class="w-full p-3 rounded-lg btn-gradient">Submit</button>
                </div>
            </div>
            <div id="payment-history-list" class="space-y-2"></div>
        </div>

        <!-- WITHDRAW PAGE -->
        <div id="withdraw-page" class="sub-page space-y-5">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('home-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Withdraw</h2>
            </div>
             <div class="card-bg p-5 rounded-2xl space-y-4">
                <select id="withdraw-method" class="w-full p-3 rounded-lg input-field"><option value="">Select Method</option><option value="bKash">bKash</option><option value="Nagad">Nagad</option></select>
                <input id="withdraw-number" type="text" placeholder="Number" class="w-full p-3 rounded-lg input-field">
                <input id="withdraw-amount" type="number" placeholder="Amount (Min 100)" class="w-full p-3 rounded-lg input-field">
                <button id="submit-withdraw-btn" class="w-full p-3 rounded-lg btn-gradient">Request Withdraw</button>
            </div>
            <div id="withdraw-history-list" class="space-y-2"></div>
        </div>

        <!-- FEATURES PAGE (Send/Receive) -->
        <div id="features-page" class="sub-page space-y-5">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('profile-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Transfer</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="card-bg p-4 text-center rounded-xl"><p class="text-xs text-gray-400">Total Sent</p><p id="total-send-display" class="font-bold text-orange-500">...</p></div>
                <div class="card-bg p-4 text-center rounded-xl"><p class="text-xs text-gray-400">Total Received</p><p id="total-receive-display" class="font-bold text-green-500">...</p></div>
            </div>
            <div class="flex gap-3">
                <button onclick="navigateTo('send-page')" class="flex-1 btn-gradient p-3 rounded-lg">Send Money</button>
                <button onclick="copyToClipboard(userData.tgChatId)" class="flex-1 bg-white border border-blue-500 text-blue-500 p-3 rounded-lg font-bold">Copy My ID</button>
            </div>
            <div id="transfer-history-list" class="space-y-2"></div>
        </div>

        <!-- SEND MONEY PAGE -->
        <div id="send-page" class="sub-page space-y-5">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('features-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Send Money</h2>
            </div>
            <div class="card-bg p-5 rounded-2xl space-y-4">
                <input id="send-recipient-id" type="text" placeholder="Recipient ID" class="w-full p-3 rounded-lg input-field">
                <input id="send-amount" type="number" placeholder="Amount" class="w-full p-3 rounded-lg input-field">
                <p id="send-fee-display" class="text-xs text-red-500 h-4"></p>
                <button id="submit-send-btn" class="w-full p-3 rounded-lg btn-gradient">Send Now</button>
            </div>
        </div>
        
        <!-- LINK TEAM & REPLACE LIST PAGES (Placeholders for structure) -->
        <div id="link-team-page" class="sub-page"><div class="p-4 text-center"><button onclick="navigateTo('profile-page')">Back</button><h2 class="font-bold mt-4">Team Page</h2><div id="linked-friends-list"></div><input id="link-friend-id" class="input-field mt-2 p-2 w-full" placeholder="Friend ID"><button id="search-friend-btn" class="btn-gradient w-full mt-2 p-2 rounded">Add</button><div id="friend-search-result"></div></div></div>
        <div id="replace-list-page" class="sub-page"><div class="p-4"><button onclick="navigateTo('profile-page')">Back</button><h2 class="font-bold text-center mb-4">Replace History</h2><div id="replace-history-list"></div></div></div>
        
        <!-- ADMIN PAGE -->
        <div id="admin-page" class="sub-page space-y-4">
             <div class="relative flex items-center justify-center mb-4">
                <button onclick="navigateTo('profile-page')" class="absolute left-0 p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-xl font-bold text-gray-800">Admin</h2>
            </div>
            <div class="card-bg p-4 rounded-xl">
                 <h3 class="font-bold mb-2">Add Stock</h3>
                 <select id="mail-type-select" class="w-full p-2 mb-2 border rounded"></select>
                 <textarea id="mail-data-textarea" class="w-full p-2 border rounded" rows="5" placeholder="email/pass..."></textarea>
                 <button id="add-mails-btn" class="btn-gradient w-full p-2 rounded mt-2">Add</button>
            </div>
            <div id="replace-requests-list" class="space-y-2"></div>
        </div>

    </main>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <div class="nav-link-native active" data-target="home-page">
            <i data-lucide="home" class="icon"></i><span>HOME</span>
        </div>
        <div class="nav-link-native" data-target="earn-page">
            <i data-lucide="rocket" class="icon"></i><span>EARN</span>
        </div>
        <div class="nav-link-native" data-target="mail-page">
            <i data-lucide="shopping-cart" class="icon"></i><span>BUY</span>
        </div>
        <div class="nav-link-native" data-target="profile-page">
            <i data-lucide="user" class="icon"></i><span>PROFILE</span>
        </div>
    </nav>

    <!-- MODALS -->
    
    <!-- Insta Rules Modal -->
    <div id="insta-rules-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[70] p-4 backdrop-blur-sm">
        <div class="card-bg rounded-2xl p-6 w-full max-w-sm relative">
            <button onclick="document.getElementById('insta-rules-modal').classList.add('hidden')" class="modal-close-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-bold text-center mb-3">‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</h3>
            <div class="text-sm text-gray-700 space-y-2">
                <p>1. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Instagram ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï Username ‡¶è‡¶¨‡¶Ç Password ‡¶¶‡¶ø‡¶®‡•§</p>
                <p>2. ‡¶Ø‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßã‡¶≤‡¶æ, ‡¶∏‡ßá‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®‡•§</p>
                <p>3. "SELL NOW" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <p>4. ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø BUY ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá‡•§</p>
                <p class="font-bold text-blue-600 bg-blue-50 p-2 rounded">‡¶∂‡¶∞‡ßç‡¶§: ‡¶ï‡ßá‡¶â ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ï‡ßá‡¶®‡¶æ‡¶∞ ‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ø‡¶¶‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá, ‡¶§‡¶¨‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá‡•§</p>
            </div>
            <button onclick="document.getElementById('insta-rules-modal').classList.add('hidden')" class="w-full btn-gradient p-3 rounded-lg mt-4">‡¶¨‡ßÅ‡¶ù‡ßá‡¶õ‡¶ø</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-xs text-center shadow-2xl">
            <p id="alert-message" class="mb-4 text-gray-800 font-medium"></p>
            <button onclick="document.getElementById('custom-alert').classList.add('hidden')" class="btn-gradient px-6 py-2 rounded-lg">OK</button>
        </div>
    </div>
    
    <!-- Purchase Success Modal -->
    <div id="purchase-success-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[80] p-4">
        <div class="card-bg rounded-2xl p-6 w-full max-w-sm relative text-center">
             <button onclick="document.getElementById('purchase-success-modal').classList.add('hidden')" class="modal-close-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
             <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto text-green-600 mb-3"><i data-lucide="check" class="w-6 h-6"></i></div>
             <h3 class="font-bold text-lg">Purchase Successful!</h3>
             <div class="bg-gray-100 p-3 rounded-lg mt-3 text-left">
                 <p class="text-xs text-gray-500">Email/User</p>
                 <div class="flex justify-between"><span id="success-email" class="font-mono font-bold text-sm truncate">...</span><i data-lucide="copy" class="w-4 h-4 cursor-pointer" onclick="copyToClipboard(document.getElementById('success-email').innerText)"></i></div>
                 <p class="text-xs text-gray-500 mt-2">Password</p>
                 <div class="flex justify-between"><span id="success-pass" class="font-mono font-bold text-sm">...</span><i data-lucide="copy" class="w-4 h-4 cursor-pointer" onclick="copyToClipboard(document.getElementById('success-pass').innerText)"></i></div>
             </div>
             <button onclick="document.getElementById('purchase-success-modal').classList.add('hidden'); navigateTo('mail-page')" class="w-full btn-gradient p-3 rounded-lg mt-4">OK</button>
        </div>
    </div>

    <script type="module">
        const ADMIN_UID = "6954647230"; // Update with your ID
        const firebaseConfig = {
            apiKey: "AIzaSyCoCy08FL_sHHdA0f2cJg0BaF-iYAhFuk0",
            authDomain: "mail-store-4692b.firebaseapp.com",
            databaseURL: "https://mail-store-4692b-default-rtdb.firebaseio.com",
            projectId: "mail-store-4692b",
            storageBucket: "mail-store-4692b.firebasestorage.app",
            messagingSenderId: "264936867411",
            appId: "1:264936867411:web:5933919e5bafae617968a6"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, limit, runTransaction, getCountFromServer, writeBatch, updateDoc, Timestamp, onSnapshot, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentUserTg = null;
        let userData = null;
        let appConfig = {};

        // --- INITIALIZATION ---
        window.onload = async () => {
            lucide.createIcons();
            setupNav();
            setupBanner();
            
            try {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                currentUserTg = window.Telegram.WebApp.initDataUnsafe.user;
                
                // Fallback for testing locally if Telegram User not found
                if (!currentUserTg) {
                    console.warn("Telegram User not detected. Using Demo User.");
                    currentUserTg = { id: "DEMO_123", first_name: "Demo", last_name: "User", username: "demo_user" };
                }

                await initUser();
            } catch (e) {
                console.error("Init Error:", e);
                document.getElementById('loader').innerHTML = '<p class="text-red-500">App Error. Please restart.</p>';
            }
        };

        async function initUser() {
            const userRef = doc(db, "users", String(currentUserTg.id));
            let snap = await getDoc(userRef);
            
            if (!snap.exists()) {
                userData = {
                    tgChatId: String(currentUserTg.id),
                    name: `${currentUserTg.first_name} ${currentUserTg.last_name || ''}`.trim(),
                    username: currentUserTg.username || null,
                    balance: 0,
                    createdAt: serverTimestamp(),
                    linkedUsers: [],
                    linkedBy: null
                };
                await setDoc(userRef, userData);
            } else {
                userData = snap.data();
                // Update basic info
                await updateDoc(userRef, { 
                    name: `${currentUserTg.first_name} ${currentUserTg.last_name || ''}`.trim(),
                    lastSeen: serverTimestamp()
                });
            }

            if (userData.tgChatId === ADMIN_UID) document.getElementById('admin-btn').classList.remove('hidden');
            
            updateUI();
            loadConfig();
            listenNotifications();
            
            // Animation out loader
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
        }
        
        async function loadConfig() {
            const snap = await getDoc(doc(db, "config", "main"));
            if (snap.exists()) {
                appConfig = snap.data();
                
                // Set Instagram Price from Config
                const instaConfig = appConfig.mails?.find(m => m.type === 'Instagram' || m.stockKey === 'instagram_stock');
                if (instaConfig && instaConfig.sellPrice) {
                    document.getElementById('insta-sell-price').textContent = `‡ß≥${instaConfig.sellPrice}`;
                } else {
                    document.getElementById('insta-sell-price').textContent = `‡ß≥2`; // Default from prompt
                }
            }
        }

        function updateUI() {
            if (!userData) return;
            document.getElementById('balance-display').textContent = `‡ß≥${userData.balance.toFixed(2)}`;
            document.getElementById('header-coin-balance').textContent = `‡ß≥${userData.balance.toFixed(2)}`;
            
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-id').textContent = `ID: ${userData.tgChatId}`;
            if(currentUserTg.photo_url) document.getElementById('profile-pic').src = currentUserTg.photo_url;
            else document.getElementById('profile-pic').src = `https://ui-avatars.com/api/?name=${userData.name}&background=007bff&color=fff`;
            
            // Header Avatar
            document.getElementById('header-initials-avatar').textContent = userData.name.charAt(0).toUpperCase();
        }

        // --- NAVIGATION LOGIC ---
        function setupNav() {
            document.querySelectorAll('.nav-link-native').forEach(link => {
                link.addEventListener('click', () => {
                    const target = link.getAttribute('data-target');
                    navigateTo(target);
                });
            });
            
            // Listeners
            document.getElementById('header-menu-btn').addEventListener('click', () => window.Telegram.WebApp.openTelegramLink("https://t.me/EXPERTearn_team"));
            document.getElementById('deposit-btn').addEventListener('click', handleDeposit);
            document.getElementById('submit-withdraw-btn').addEventListener('click', handleWithdraw);
            document.getElementById('submit-send-btn').addEventListener('click', handleSend);
            document.getElementById('submit-insta-sell-btn').addEventListener('click', handleInstaSell);
            document.getElementById('search-friend-btn').addEventListener('click', handleSearchFriend);
            document.getElementById('add-mails-btn').addEventListener('click', handleAddStock);
            
            document.getElementById('send-amount').addEventListener('input', function() {
                const val = parseFloat(this.value) || 0;
                document.getElementById('send-fee-display').textContent = val > 0 ? `Fee (5%): ‡ß≥${(val*0.05).toFixed(2)}` : '';
            });
        }

        window.navigateTo = function(pageId) {
            // Hide all pages
            document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
            // Show target
            const target = document.getElementById(pageId);
            if(target) target.classList.add('active');
            
            // Update Bottom Nav state
            document.querySelectorAll('.nav-link-native').forEach(link => {
                if(link.getAttribute('data-target') === pageId) link.classList.add('active');
                else link.classList.remove('active');
            });

            // Page Specific Loads
            if (pageId === 'mail-page') loadStore();
            if (pageId === 'pay-page') loadHistory('deposits', 'userId', 'payment-history-list');
            if (pageId === 'withdraw-page') loadHistory('withdrawals', 'userId', 'withdraw-history-list');
            if (pageId === 'notification-page') loadNotificationsPage();
            if (pageId === 'features-page') loadTransferHistory();
            if (pageId === 'link-team-page') loadTeam();
            if (pageId === 'admin-page') loadAdmin();
            if (pageId === 'replace-list-page') loadReplaceHistory();
            
            window.scrollTo(0,0);
            lucide.createIcons();
        };
        
        window.showComingSoon = () => showAlert("Manual Earn is Coming Soon!");

        // --- CORE FEATURES ---

        // 1. Instagram Sell Logic
        async function handleInstaSell() {
            const user = document.getElementById('insta-username').value.trim();
            const pass = document.getElementById('insta-password').value.trim();
            const email = document.getElementById('insta-email').value.trim();
            
            if (!user || !pass || !email) return showAlert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            
            document.getElementById('loader').style.display = 'flex';
            try {
                // Get config for price
                const instaConfig = appConfig.mails?.find(m => m.stockKey === 'instagram_stock') || { sellPrice: 2, priceBdt: 5 }; // Default fallback
                
                // Add to Stock Collection directly (so it appears in Buy Page)
                // We use a specific structure: 'instagram_stock'
                await addDoc(collection(db, "instagram_stock"), {
                    email: email,
                    password: pass,
                    uid: user, // Display username as UID
                    sellerId: userData.tgChatId,
                    sellerName: userData.name,
                    costPrice: instaConfig.sellPrice || 2, // Price seller gets
                    sellingPrice: instaConfig.priceBdt || 5, // Price buyer pays
                    isSold: false,
                    createdAt: serverTimestamp(),
                    status: 'market' // Logic: waiting to be sold
                });
                
                showAlert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡ßá‡¶â ‡¶ï‡¶ø‡¶®‡¶≤‡ßá ‡¶è‡¶¨‡¶Ç ‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá‡•§");
                // Clear inputs and go back
                ['insta-username', 'insta-password', 'insta-email'].forEach(id => document.getElementById(id).value = '');
                navigateTo('earn-page');
                
            } catch (e) {
                console.error(e);
                showAlert("Error: " + e.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        // 2. Naval Coin Sell (Simulated Request)
        window.handleNavalSell = async () => {
            const senderId = document.getElementById('naval-sender-id').value;
            const amount = document.getElementById('naval-amount').value;
            if(!senderId || !amount) return showAlert("Fill all fields");
            
            // Logic similar to deposit, just a request
            await addDoc(collection(db, "coin_sells"), {
                userId: userData.tgChatId,
                senderId, amount,
                type: 'Naval Coin',
                status: 'pending',
                timestamp: serverTimestamp()
            });
            showAlert("Request Submitted. Admin will check.");
            navigateTo('earn-page');
        };

        // 3. Notification Logic (Full Page)
        function listenNotifications() {
            const q = query(collection(db, "notifications"), where("recipientId", "in", [userData.tgChatId, "all"]), orderBy("createdAt", "desc"), limit(1));
            onSnapshot(q, (snap) => {
                if(!snap.empty) {
                    // Check if newer than last seen
                    const latest = snap.docs[0].data();
                    // Simple dot logic
                    document.getElementById('notif-dot').classList.remove('hidden');
                }
            });
        }

        async function loadNotificationsPage() {
            const container = document.getElementById('notification-list');
            container.innerHTML = '<div class="premium-loader-spinner mx-auto"></div>';
            document.getElementById('notif-dot').classList.add('hidden'); // Mark read
            
            try {
                const q = query(collection(db, "notifications"), where("recipientId", "in", [userData.tgChatId, "all"]), orderBy("createdAt", "desc"), limit(20));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    container.innerHTML = '<div class="text-center text-gray-400 mt-10"><i data-lucide="bell-off" class="mx-auto w-10 h-10 mb-2"></i><p>No notifications</p></div>';
                    lucide.createIcons();
                    return;
                }
                
                container.innerHTML = snap.docs.map(d => {
                    const n = d.data();
                    const date = n.createdAt?.toDate().toLocaleDateString() || '';
                    return `<div class="card-bg p-4 rounded-xl border-l-4 border-blue-500">
                        <h4 class="font-bold text-gray-800">${n.title}</h4>
                        <p class="text-sm text-gray-600 mt-1">${n.message}</p>
                        <p class="text-xs text-gray-400 mt-2 text-right">${date}</p>
                    </div>`;
                }).join('');
                
            } catch(e) {
                container.innerHTML = '<p class="text-center text-red-500">Failed to load</p>';
            }
        }

        // 4. Store & Buy Logic
        async function loadStore() {
            const container = document.getElementById('mail-list-container');
            container.innerHTML = '<div class="premium-loader-spinner mx-auto"></div>';
            
            // Combine Config Mails + Instagram Manual Stock logic check
            // Note: Usually we read from Config to know which Collections to query
            // For this code, we assume 'instagram_stock' is a collection, and others are in config
            
            let productsHTML = '';
            
            // 1. Load Configured Products (e.g. Gmail OTP)
            const mails = appConfig.mails || [];
            for (const product of mails) {
                // Check stock
                const stockQ = query(collection(db, product.stockKey), where("isSold", "==", false));
                const countSnap = await getCountFromServer(stockQ);
                const stock = countSnap.data().count;
                
                productsHTML += createProductCard(product.type, product.priceBdt, stock, product.stockKey);
            }
            
            container.innerHTML = productsHTML || '<p class="text-center mt-5">No products available</p>';
            lucide.createIcons();
            
            // Load History
            loadBuyHistory();
        }

        function createProductCard(title, price, stock, key) {
            const isStock = stock > 0;
            const btnClass = isStock ? 'btn-gradient' : 'bg-gray-300 cursor-not-allowed text-gray-500';
            const buyFn = isStock ? `buyItem('${key}', ${price}, '${title}')` : '';
            
            return `<div class="card-bg p-4 rounded-xl flex justify-between items-center">
                <div>
                    <h3 class="font-bold text-lg">${title}</h3>
                    <p class="text-sm text-gray-500">Stock: <span class="${stock<5?'text-red-500':'text-green-600'} font-bold">${stock}</span></p>
                    <p class="font-bold text-blue-600">‡ß≥${price}</p>
                </div>
                <button onclick="${buyFn}" class="${btnClass} px-4 py-2 rounded-lg text-sm font-bold shadow-sm">BUY NOW</button>
            </div>`;
        }

        window.buyItem = async (collectionName, price, title) => {
            if(userData.balance < price) return showAlert("Insufficient Balance! Please Deposit.");
            if(!confirm(`Buy ${title} for ‡ß≥${price}?`)) return;
            
            document.getElementById('loader').style.display = 'flex';
            try {
                await runTransaction(db, async (t) => {
                    // 1. Get Unsold Item
                    const q = query(collection(db, collectionName), where("isSold", "==", false), limit(1));
                    const snap = await getDocs(q);
                    if(snap.empty) throw "Stock Finished just now!";
                    
                    const itemDoc = snap.docs[0];
                    const itemData = itemDoc.data();
                    const itemRef = itemDoc.ref;
                    
                    // 2. Check Balance Again
                    const userRef = doc(db, "users", userData.tgChatId);
                    const userSnap = await t.get(userRef);
                    const currentBal = userSnap.data().balance;
                    if(currentBal < price) throw "Low Balance";
                    
                    // 3. Execute
                    t.update(userRef, { balance: currentBal - price });
                    // If this was a seller item (has sellerId), we mark soldAt for payout logic
                    t.update(itemRef, { 
                        isSold: true, 
                        soldTo: userData.tgChatId, 
                        soldAt: serverTimestamp(),
                        payoutStatus: itemData.sellerId ? 'pending' : 'none' // For manual earning payout
                    });
                    
                    // 4. Log Purchase
                    const purchaseRef = doc(collection(db, "mail_purchases"));
                    t.set(purchaseRef, {
                        userId: userData.tgChatId,
                        item: title,
                        price: price,
                        email: itemData.email,
                        password: itemData.password,
                        uid: itemData.uid || null,
                        purchasedAt: serverTimestamp(),
                        collection: collectionName
                    });
                    
                    // Local update for UI
                    return { email: itemData.email, password: itemData.password };
                }).then((data) => {
                    userData.balance -= price;
                    updateUI();
                    document.getElementById('success-email').innerText = data.email || 'N/A';
                    document.getElementById('success-pass').innerText = data.password || 'N/A';
                    document.getElementById('purchase-success-modal').classList.remove('hidden');
                    lucide.createIcons();
                });
                
                loadStore(); // Refresh
            } catch (e) {
                showAlert(typeof e === 'string' ? e : "Transaction Failed");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        async function loadBuyHistory() {
            const list = document.getElementById('mail-purchase-history');
            const q = query(collection(db, "mail_purchases"), where("userId", "==", userData.tgChatId), orderBy("purchasedAt", "desc"), limit(10));
            const snap = await getDocs(q);
            
            list.innerHTML = snap.docs.map(d => {
                const p = d.data();
                return `<div class="card-bg p-3 rounded-lg">
                    <div class="flex justify-between"><span class="font-bold">${p.item}</span><span class="text-xs text-gray-400">${p.purchasedAt?.toDate().toLocaleDateString()}</span></div>
                    <div class="bg-gray-50 p-2 mt-2 rounded text-xs font-mono break-all select-all">${p.email}:${p.password}</div>
                </div>`;
            }).join('');
        }

        // 5. Finance Functions
        window.handleDeposit = async () => {
            const amount = parseInt(document.getElementById('deposit-amount').value);
            const method = document.getElementById('deposit-method').value;
            const tx = document.getElementById('deposit-txid').value;
            
            if(!amount || !method || !tx) return showAlert("Fill all fields");
            
            await addDoc(collection(db, "deposits"), {
                userId: userData.tgChatId,
                amount, method, transactionId: tx,
                status: 'pending', requestedAt: serverTimestamp()
            });
            showAlert("Deposit Request Sent!");
            navigateTo('pay-page'); // reload history
        };

        window.handleWithdraw = async () => {
             const amount = parseInt(document.getElementById('withdraw-amount').value);
             if(amount < 100 || userData.balance < amount) return showAlert("Invalid Amount or Low Balance");
             
             await addDoc(collection(db, "withdrawals"), {
                userId: userData.tgChatId, amount,
                status: 'pending', requestedAt: serverTimestamp()
             });
             // Deduct immediately or wait for admin? Usually deduct
             await updateDoc(doc(db, "users", userData.tgChatId), { balance: increment(-amount) });
             userData.balance -= amount;
             updateUI();
             showAlert("Withdraw Request Sent!");
             navigateTo('withdraw-page');
        };

        window.handleSend = async () => {
            const toId = document.getElementById('send-recipient-id').value.trim();
            const amount = parseFloat(document.getElementById('send-amount').value);
            const fee = amount * 0.05;
            const total = amount + fee;
            
            if(total > userData.balance) return showAlert("Low Balance (Inc. 5% fee)");
            
            document.getElementById('loader').style.display = 'flex';
            try {
                await runTransaction(db, async (t) => {
                    const receiverRef = doc(db, "users", toId);
                    const rSnap = await t.get(receiverRef);
                    if(!rSnap.exists()) throw "Receiver not found";
                    
                    const senderRef = doc(db, "users", userData.tgChatId);
                    t.update(senderRef, { balance: increment(-total) });
                    t.update(receiverRef, { balance: increment(amount) });
                    
                    t.set(doc(collection(db, "transfers")), {
                        from: userData.tgChatId, to: toId, amount, fee, timestamp: serverTimestamp()
                    });
                });
                userData.balance -= total;
                updateUI();
                showAlert(`Sent ‡ß≥${amount} to ${toId}`);
                navigateTo('features-page');
            } catch(e) { showAlert(e); }
            finally { document.getElementById('loader').style.display = 'none'; }
        };

        // Helpers
        async function loadHistory(col, field, elemId) {
            const el = document.getElementById(elemId);
            el.innerHTML = 'Loading...';
            const q = query(collection(db, col), where(field, "==", userData.tgChatId), orderBy("requestedAt", "desc"), limit(10));
            const snap = await getDocs(q);
            el.innerHTML = snap.docs.map(d => {
                const data = d.data();
                const color = data.status==='approved'?'text-green-600':(data.status==='rejected'?'text-red-600':'text-yellow-600');
                return `<div class="flex justify-between border-b p-2"><span class="font-bold">‡ß≥${data.amount}</span><span class="${color} capitalize text-xs font-bold">${data.status}</span></div>`;
            }).join('') || '<p class="text-center text-gray-400 text-sm">Empty</p>';
        }
        
        // --- UTILS ---
        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text);
            showAlert("Copied!");
        };
        window.showAlert = (msg) => {
            document.getElementById('alert-message').innerText = msg;
            document.getElementById('custom-alert').classList.remove('hidden');
        };
        
        function setupBanner() {
            let idx = 0;
            const slides = document.querySelectorAll('.slide');
            setInterval(() => {
                idx = (idx + 1) % slides.length;
                document.getElementById('slides').style.transform = `translateX(-${idx * 100}%)`;
            }, 4000);
        }

        // Admin Placeholders (Minimal)
        async function loadAdmin() {
            if(userData.tgChatId !== ADMIN_UID) return navigateTo('home-page');
            // Populate select
            const sel = document.getElementById('mail-type-select');
            sel.innerHTML = (appConfig.mails||[]).map(m => `<option value="${m.stockKey}">${m.type}</option>`).join('') + `<option value="instagram_stock">Instagram (Manual)</option>`;
            
            // Load Replace Requests
            const q = query(collection(db, "replace_requests"), where("status", "==", "pending"));
            const snap = await getDocs(q);
            document.getElementById('replace-requests-list').innerHTML = snap.docs.map(d => 
                `<div class="card-bg p-2"><p>${d.data().reason}</p><button class="text-green-500 text-xs" onclick="alert('Impl in backend')">Resolve</button></div>`
            ).join('');
        }
        window.handleAddStock = async () => {
            const key = document.getElementById('mail-type-select').value;
            const data = document.getElementById('mail-data-textarea').value;
            const batch = writeBatch(db);
            data.split('\n').forEach(line => {
                if(line.includes('/')) {
                    const [e, p] = line.split('/');
                    batch.set(doc(collection(db, key)), { email: e.trim(), password: p.trim(), isSold: false, createdAt: serverTimestamp() });
                }
            });
            await batch.commit();
            showAlert("Added!");
        };
        
        // Placeholder logic for Team and Replace History
        async function loadTeam() { document.getElementById('linked-friends-list').innerHTML = '<p class="text-center text-gray-400">No team members</p>'; }
        async function loadReplaceHistory() { document.getElementById('replace-history-list').innerHTML = '<p class="text-center text-gray-400">No history</p>'; }
        window.handleSearchFriend = () => showAlert("Functionality retained from previous version");

    </script>
</body>
</html>
